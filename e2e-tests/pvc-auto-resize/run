#!/bin/bash

set -o errexit

test_dir=$(realpath "$(dirname "$0")")
. "${test_dir}/../functions"

function get_default_storageclass() {
	kubectl_bin get sc -o jsonpath='{.items[?(@.metadata.annotations.storageclass\.kubernetes\.io/is-default-class=="true")].metadata.name}'
}

function ensure_default_sc_allows_expansion() {
	local default_sc
	default_sc=$(get_default_storageclass)

	echo "Checking if default storageclass ${default_sc} allows volume expansion"

	local allowVolumeExpansion
	allowVolumeExpansion=$(kubectl_bin get sc -o jsonpath='{.items[?(@.metadata.name=="'"${default_sc}"'")].allowVolumeExpansion}')

	if [[ ${allowVolumeExpansion} != "true" ]]; then
		echo "Default storageclass ${default_sc} does not allow volume expansion"
		exit 0
	fi
}

function fill_disk_to_threshold() {
	local pod=$1
	local threshold=$2
	local size_mb=$3

	echo "Filling disk on ${pod} to approximately ${threshold}% (creating ${size_mb}MB file)"

	kubectl_bin exec "${pod}" -c mongod -- bash -c "dd if=/dev/zero of=/data/db/fillfile bs=1M count=${size_mb} 2>/dev/null || true"

	local usage
	usage=$(kubectl_bin exec "${pod}" -c mongod -- bash -c "df /data/db | tail -1 | awk '{print \$5}' | sed 's/%//'")
	echo "Current disk usage on ${pod}: ${usage}%"
}

function get_pvc_size() {
	local pvc=$1
	kubectl_bin get pvc "${pvc}" -o jsonpath='{.status.capacity.storage}'
}

function wait_for_auto_resize() {
	local pvc=$1
	local expected_size=$2
	local max_retry=${3:-60}
	local sleep_time=${4:-10}

	echo "Waiting for PVC ${pvc} to auto-resize to ${expected_size}"

	local retry=0
	until [[ $(get_pvc_size "${pvc}") == "${expected_size}" ]]; do
		if [[ $retry -ge $max_retry ]]; then
			echo
			echo "PVC ${pvc} did not resize to ${expected_size}, max retries exceeded"
			kubectl_bin get pvc "${pvc}" -o yaml
			exit 1
		fi
		echo -n "."
		sleep $sleep_time
		retry=$((retry + 1))
	done

	echo
	echo "PVC ${pvc} successfully resized to ${expected_size}"
}

function check_autoscaling_status() {
	local cluster=$1
	local expected_resize_count=$2
	shift 2
	local pvc_names=("$@")
	local max_retry=${max_retry:-30}
	local sleep_time=${sleep_time:-10}

	echo "Checking autoscaling status for PVCs: ${pvc_names[*]}"
	echo "Expected resize count per PVC: ${expected_resize_count}"

	for pvc_name in "${pvc_names[@]}"; do
		local retry=0
		until [[ $(kubectl_bin get psmdb "${cluster}" -o jsonpath="{.status.storageAutoscaling.${pvc_name}.resizeCount}") -eq ${expected_resize_count} ]]; do
			if [[ $retry -ge $max_retry ]]; then
				echo
				echo "ERROR: PVC ${pvc_name} resize count did not reach ${expected_resize_count}, max retries exceeded"
				kubectl_bin get psmdb "${cluster}" -o jsonpath='{.status.storageAutoscaling}' | jq .
				exit 1
			fi
			echo -n "."
			sleep $sleep_time
			retry=$((retry + 1))
		done
	done
}

function apply_resourcequota() {
	local quota=$1
	local default_sc
	default_sc=$(get_default_storageclass)

	echo "Applying resourcequota for default storageclass ${default_sc} with quota ${quota}"

	cat "${test_dir}/conf/resourcequota.yml" \
		| sed "s/STORAGECLASS/${default_sc}/" \
		| sed "s/QUOTA/${quota}/" \
		| kubectl_bin apply -f -
}

set_debug

if [ "$EKS" == 1 ]; then
	echo "EKS environment detected, creating storageclass for EBS volumes"
	kubectl_bin apply -f "${test_dir}/conf/eks-storageclass.yml"
else
	ensure_default_sc_allows_expansion
fi

create_infra "${namespace}"

desc 'create secrets and psmdb client'
kubectl_bin apply \
	-f "$conf_dir/secrets.yml" \
	-f "$conf_dir/client.yml"

desc 'create PSMDB cluster with storageAutoscaling enabled'
cluster="some-name"
spinup_psmdb "${cluster}-rs0" "$test_dir/conf/$cluster.yml"

desc 'verify initial PVC size is 1Gi'
initial_size=$(get_pvc_size "mongod-data-${cluster}-rs0-0")
echo "Initial PVC size: ${initial_size}"

if [[ ${initial_size} != "1Gi" ]]; then
	echo "ERROR: Initial PVC size should be 1Gi, got ${initial_size}"
	exit 1
fi

desc 'fill disk to trigger autoscaling threshold 80 percent'
# 1Gi = 1024MB, we want to fill to ~85% to trigger the 80% threshold
# Fill with 850MB to exceed threshold
fill_disk_to_threshold "${cluster}-rs0-0" 80 850

desc 'wait for auto-resize to trigger'
wait_for_auto_resize "mongod-data-${cluster}-rs0-0" "3Gi" 60 10
wait_for_auto_resize "mongod-data-${cluster}-rs0-1" "3Gi" 60 10
wait_for_auto_resize "mongod-data-${cluster}-rs0-2" "3Gi" 60 10

desc 'verify autoscaling status is updated'
check_autoscaling_status "${cluster}" 1 "mongod-data-${cluster}-rs0-0" "mongod-data-${cluster}-rs0-1" "mongod-data-${cluster}-rs0-2"

desc 'wait for cluster consistency after resize'
wait_cluster_consistency "$cluster" 64

desc 'verify cluster is ready'
kubectl_bin get psmdb "${cluster}" -o jsonpath='{.status.state}' | grep -q "ready"

desc 'test namespace resource quota enforcement'
# The cluster has 3 replicas with 3Gi PVCs = 9Gi total
apply_resourcequota 9Gi

echo "Filling disk again to trigger autoscaling with quota limit"
fill_disk_to_threshold "${cluster}-rs0-0" 80 2400

echo "Waiting to verify PVC does not resize beyond quota (should stay at 3Gi)"
sleep 30
current_size=$(get_pvc_size "mongod-data-${cluster}-rs0-0")
if [[ ${current_size} != "3Gi" ]]; then
	echo "WARNING: PVC size is ${current_size}, expected to stay at 3Gi due to quota"
fi

desc 'increase quota to allow further autoscaling'
# Now increase quota to allow next resize step (3 replicas * 5Gi = 15Gi)
apply_resourcequota 15Gi
wait_for_auto_resize "mongod-data-${cluster}-rs0-0" "5Gi" 60 10
wait_for_auto_resize "mongod-data-${cluster}-rs0-1" "5Gi" 60 10
wait_for_auto_resize "mongod-data-${cluster}-rs0-2" "5Gi" 60 10

desc 'verify cluster consistency after quota test'
wait_cluster_consistency "$cluster" 64

desc 'test maxSize limit'
# Increase quota to allow maxSize testing (3 replicas * 10Gi maxSize = 30Gi)
apply_resourcequota 30Gi
echo "Continuing to fill disk to test maxSize enforcement"
fill_disk_to_threshold "${cluster}-rs0-0" 80 4000
wait_for_auto_resize "mongod-data-${cluster}-rs0-0" "7Gi" 60 10

fill_disk_to_threshold "${cluster}-rs0-0" 80 5600
wait_for_auto_resize "mongod-data-${cluster}-rs0-0" "9Gi" 60 10

fill_disk_to_threshold "${cluster}-rs0-0" 80 7200

final_size=$(get_pvc_size "mongod-data-${cluster}-rs0-0")
if [[ ${final_size} == "10Gi" ]]; then
	echo "PVC correctly stopped at maxSize 10Gi"
elif [[ ${final_size} == "9Gi" ]]; then
	echo "PVC is at 9Gi, will resize to 10Gi (maxSize)"
	wait_for_auto_resize "mongod-data-${cluster}-rs0-0" "10Gi" 60 10
	wait_for_auto_resize "mongod-data-${cluster}-rs0-1" "10Gi" 60 10
	wait_for_auto_resize "mongod-data-${cluster}-rs0-2" "10Gi" 60 10
else
	echo "WARNING: PVC size is ${final_size}, expected 9Gi or 10Gi"
fi

desc 'verify final autoscaling status'
check_autoscaling_status "${cluster}" 4 "mongod-data-${cluster}-rs0-0" "mongod-data-${cluster}-rs0-1" "mongod-data-${cluster}-rs0-2"

wait_cluster_consistency "$cluster" 64

destroy "${namespace}"
desc "test passed"
