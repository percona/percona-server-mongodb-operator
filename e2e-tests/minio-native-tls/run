#!/bin/bash

set -o errexit

test_dir=$(realpath "$(dirname "$0")")
. "${test_dir}/../functions"
set_debug

# Generate self-signed certificates for MinIO instances
generate_minio_certificates() {
  local namespace=$1

  desc "Generating self-signed certificates for MinIO instances"

  # Generate certificate for first MinIO
  echo "Creating certificate for minio-service..."
  openssl req -x509 -newkey rsa:4096 \
    -keyout minio-key.pem \
    -out minio-cert.pem \
    -days 365 -nodes \
    -subj "/CN=minio-service" \
    -addext "subjectAltName=DNS:minio-service,DNS:minio-service.${namespace},DNS:minio-service.${namespace}.svc,DNS:minio-service.${namespace}.svc.cluster.local,DNS:localhost"

  kubectl create secret generic minio-tls \
    --from-file=public.crt=minio-cert.pem \
    --from-file=private.key=minio-key.pem

  # Generate certificate for second MinIO (DIFFERENT certificate!)
  echo "Creating certificate for minio2-service..."
  openssl req -x509 -newkey rsa:4096 \
    -keyout minio2-key.pem \
    -out minio2-cert.pem \
    -days 365 -nodes \
    -subj "/CN=minio2-service" \
    -addext "subjectAltName=DNS:minio2-service,DNS:minio2-service.${namespace},DNS:minio2-service.${namespace}.svc,DNS:minio2-service.${namespace}.svc.cluster.local,DNS:localhost"

  kubectl create secret generic minio2-tls \
      --from-file=public.crt=minio2-cert.pem \
      --from-file=private.key=minio2-key.pem

  echo ""
  echo "Verifying certificates are different:"

  echo "MinIO 1 fingerprint:"
  openssl x509 -in minio-cert.pem -noout -fingerprint

  echo "MinIO 2 fingerprint:"
  openssl x509 -in minio2-cert.pem -noout -fingerprint

  echo ""
  echo "âœ“ Certificates generated successfully!"
  echo "  Files: minio-cert.pem, minio-key.pem, minio2-cert.pem, minio2-key.pem"
}

create_infra "${namespace}"

generate_minio_certificates "${namespace}"

desc 'Phase 1: Deploy first MinIO and create CA bundle'

# Create CA bundle secret for first MinIO (for PSMDB to use)
kubectl_bin create secret generic minio-ca-bundle \
  --from-file=ca.crt=minio-cert.pem \
  -n ${namespace}

deploy_minio minio-tls
apply_s3_storage_secrets

desc 'Phase 1: Testing single CA bundle with one MinIO storage'

desc 'Testing on not sharded cluster'

echo 'Creating PSMDB cluster'
cluster="some-name"
kubectl_bin apply -f "${test_dir}/conf/secrets.yml"
kubectl_bin apply -f "${conf_dir}/client_with_tls.yml"

apply_cluster "${test_dir}/conf/${cluster}-single-ca.yml"

echo "check if all pods started"
wait_for_running ${cluster}-rs0 3
wait_cluster_consistency ${cluster}

echo "Verify CA bundle configuration"
kubectl_bin exec ${cluster}-rs0-0 -n ${namespace} -c backup-agent -- \
  ls -la /etc/s3/certs/ca-bundle.crt || {
    echo "ERROR: CA bundle file not found!"
    exit 1
}

echo "Verify SSL_CERT_FILE env var is set"
kubectl_bin exec ${cluster}-rs0-0 -n ${namespace} -c backup-agent -- \
  env | grep SSL_CERT_FILE || {
    echo "ERROR: SSL_CERT_FILE not set!"
    exit 1
}

echo "Verify certificate content"
cert_count=$(kubectl_bin exec ${cluster}-rs0-0 -n ${namespace} -c backup-agent -- \
  grep -c "BEGIN CERTIFICATE" /etc/s3/certs/ca-bundle.crt)
if [ "$cert_count" != "1" ]; then
    echo "ERROR: Expected 1 certificate, found $cert_count"
    exit 1
fi
echo "CA bundle contains 1 certificate"

echo "Verify single CA uses direct Secret mount (not ProjectedVolume)"
if kubectl_bin get pod ${cluster}-rs0-0 -n ${namespace} -o yaml | grep -q "ca-bundle-in"; then
    echo "ERROR: ProjectedVolume should not exist for single CA!"
    exit 1
fi
echo "Direct Secret mount used (no ProjectedVolume)"

echo "Testing WITH CA bundle..."
kubectl_bin exec ${cluster}-rs0-0 -n ${namespace} -c backup-agent -- \
  curl -v --cacert /etc/s3/certs/ca-bundle.crt https://minio-service:9000 2>&1 | \
  grep "SSL certificate verify ok" || {
    echo "ERROR: TLS verification failed!"
    kubectl_bin exec ${cluster}-rs0-0 -n ${namespace} -c backup-agent -- \
      curl -v --cacert /etc/s3/certs/ca-bundle.crt https://minio-service:9000 2>&1 | head -40
    exit 1
}
echo "TLS works with CA bundle"

desc 'Phase 2: Add second storage and verify auto-merge of CA bundles'

kubectl_bin create secret generic minio2-ca-bundle \
  --from-file=ca.crt=minio2-cert.pem \
  -n ${namespace}


# Deploy second MinIO (without TLS)

deploy_minio "minio2-tls" "minio2-service"

echo "Verifying certificates are different"
minio1_fingerprint=$(openssl x509 -in minio-cert.pem -noout -fingerprint | cut -d= -f2)
minio2_fingerprint=$(openssl x509 -in minio2-cert.pem -noout -fingerprint | cut -d= -f2)
if [ "$minio1_fingerprint" == "$minio2_fingerprint" ]; then
    echo "ERROR: Both MinIO instances have the same certificate!"
    exit 1
fi
echo "Certificates are different"
echo "  MinIO1: $minio1_fingerprint"
echo "  MinIO2: $minio2_fingerprint"

echo "Updating cluster to use two MinIO storages with different CAs"

kubectl_bin patch psmdb some-name -n ${namespace} --type=merge -p '
{
  "spec": {
    "backup": {
      "storages": {
        "minio2": {
          "type": "minio",
          "minio": {
            "credentialsSecret": "minio2-secret",
            "region": "us-east-1",
            "bucket": "operator-testing",
            "endpointUrl": "https://minio2-service:9000",
            "insecureSkipTLSVerify": false,
            "secure": true,
            "caBundle": {
              "name": "minio2-ca-bundle",
              "key": "ca.crt"
            }
          }
        }
      }
    }
  }
}'

wait_for_running ${cluster}-rs0 3
wait_cluster_consistency ${cluster}

# Verify BOTH CA certificates are in the bundle
echo "Verify combined CA bundle"
cert_count=$(kubectl_bin exec ${cluster}-rs0-0 -n ${namespace} -c backup-agent -- \
  grep -c "BEGIN CERTIFICATE" /etc/s3/certs/ca-bundle.crt)
if [ "$cert_count" != "2" ]; then
    echo "ERROR: Expected 2 certificates in combined bundle, found $cert_count"
    exit 1
fi
echo "CA bundle contains 2 certificates (auto-merged)"

# Verify volumes configuration
echo "Verify ProjectedVolume is used"
kubectl_bin get pod ${cluster}-rs0-0 -n ${namespace} -o yaml | \
  grep -q "ca-bundle-in" || {
    echo "ERROR: ProjectedVolume 'ca-bundle-in' not found!"
    exit 1
}
echo "ProjectedVolume configured correctly"

echo "Verify SSL_CERT_FILE env var is set"
kubectl_bin exec ${cluster}-rs0-0 -n ${namespace} -c backup-agent -- \
  env | grep SSL_CERT_FILE || {
    echo "ERROR: SSL_CERT_FILE not set!"
    exit 1
}

# Test connection to BOTH MinIO instances

echo "Testing connection to first MinIO (should still work)"
if kubectl_bin exec ${cluster}-rs0-0 -n ${namespace} -c backup-agent -- \
  curl -v --cacert /etc/s3/certs/ca-bundle.crt https://minio-service:9000 2>&1 | \
  grep -q "SSL certificate verify ok"; then
    echo "Connection to first MinIO successful"
else
    echo "ERROR: TLS verification failed for minio-service!"
    echo "Showing curl output:"
    kubectl_bin exec ${cluster}-rs0-0 -n ${namespace} -c backup-agent -- \
      curl -v --cacert /etc/s3/certs/ca-bundle.crt https://minio-service:9000 2>&1 | head -40
    exit 1
fi

echo "Testing connection to second MinIO"
if kubectl_bin exec ${cluster}-rs0-0 -n ${namespace} -c backup-agent -- \
  curl -v --cacert /etc/s3/certs/ca-bundle.crt https://minio2-service:9000 2>&1 | \
  grep -q "SSL certificate verify ok"; then
    echo "Connection to second MinIO successful"
else
    echo "ERROR: TLS verification failed for minio2-service!"
    echo "Showing curl output:"
    kubectl_bin exec ${cluster}-rs0-0 -n ${namespace} -c backup-agent -- \
      curl -v --cacert /etc/s3/certs/ca-bundle.crt https://minio2-service:9000 2>&1 | head -40
    exit 1
fi

destroy "$namespace"

desc 'test passed'